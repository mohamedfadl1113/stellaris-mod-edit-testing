double_shellworld_0 = {
	entity = "ssh_double_shellworld_0_entity"
	construction_entity = "ssh_double_shellworld_0_entity"
	portrait = "GFX_megastructure_construction_background"
	build_time = 2700 #~7years
	scales_with_planet = yes
	prerequisites = {
		ssh_tech_matrioshka_worlds
	}
	show_prereqs = yes
	potential = {
		has_technology = ssh_tech_matrioshka_worlds
		NOT = { has_global_flag = ssh_shellworld_deactivated }
	}
	possible = {
		custom_tooltip = {
			fail_text = "requires_inside_border"
			is_inside_border = from
		}
	}
	resources = {
		category = megastructures
		cost = {
			unity = 2000
		}
		cost = {
			trigger = { country_uses_bio_ships = no }
			alloys = 5000
		}
		cost = {
			trigger = { country_uses_bio_ships = yes }
			alloys = 5000
			mult = 0.5
		}
		cost = {
			trigger = { country_uses_bio_ships = yes }
			food = 5000
			mult = @halved_alloy_to_food_cost_ratio
		}
		upkeep = {
			energy = 10
		}
	}

	placement_rules = {
		planet_possible = {
			custom_tooltip = {
				fail_text = "requires_surveyed_planet"
				is_surveyed = { # prevent leaking habitability information
					who = prev.from
					status = yes
				}
			}
			custom_tooltip = {
				fail_text = "requires_no_anomaly"
				NOT = { has_anomaly = yes }
			}
			custom_tooltip = {
				fail_text = "requires_colonized_planet_orbital_ring"
				is_colony = yes
				exists = owner
				exists = controller
				controller = { is_same_value = prev.owner }
			}
			custom_tooltip = {
				fail_text = "requires_not_hostile_or_primitive"
				NOR = {
					planet_is_hostile_or_crisis = yes
					AND = {
						exists = owner
						owner = {
							is_country_type = primitive
						}
					}
				}
			}
			custom_tooltip = {
				fail_text = "ssh_requires_shellworld"
				has_planet_flag = shellworld
			}
			custom_tooltip = {
				fail_text = "ssh_double_shellworld_already_built"
				NOT = {
					has_planet_flag = is_under_shellworld_construction
				}
			}
			custom_tooltip = {
				fail_text = "ssh_double_shellworld_already_built"
				NOT = {
					has_planet_flag = double_shellworld
				}
			}
		}
	}

	on_build_complete = {
		fromfrom.planet = {
			set_planet_flag = is_under_shellworld_construction
			set_planet_flag = has_megastructure
			save_event_target_as = ssh_double_shellworld_planet
		}
		from = {
			country_event = { id = ssh_cn.4 }
		}
	}

	ai_weight = {
		weight = 10
		# Do we need it? (No districts left? No other colonies?)
		# If more than 0 districts free: don't build it
		modifier = {
			factor = 0.1
			fromfrom.planet = {
				num_free_districts = {
					type = any
					value > 0
				}
			}
		}
		# Upkeep Affordable?
		modifier = {
			factor = 0.1
			from = {
				OR = {
					has_monthly_income = {
						resource = energy
						value < 70
					}
					has_monthly_income = {
						resource = alloys
						value < 20
					}
				}
			}
		}
		# Do we have enough resources?
		modifier = {
			factor = 0.1
			from = {
				AND = {
					resource_stockpile_compare = {
						resource = minerals
						value < 17500
					}
					resource_stockpile_compare = {
						resource = volatile_motes
						value < 750
					}
					resource_stockpile_compare = {
						resource = exotic_gases
						value < 750
					}
				}
			}
		}
		# Better habitable megastructures researched already? !! just maximize the shellworld and dont create a new one if better tech available
		#modifier = {
		#	factor = 0.1
		#	OR = {
		#		has_technology = ssh_tech_gas_giant_shellworlds
		#		has_technology = ssh_tech_ederspheres
		#		has_technology = ssh_tech_black_hole_shellworld
		#		# TODO: Add giga's habitable megas to the list (alderson, birch world)
		#	}
		#}

		# Good System?
		modifier = {
			factor = 0.1
			any_neighbor_system = {
				exists = owner
				NOT = {
					owner = { is_same_value = from }
				}
			}
		}
		# Personality?
		modifier = {
			factor = 1.5
			from = {
				OR = {
					has_ai_personality = xenophobic_isolationists
					has_ai_personality = fanatic_purifiers
					has_ai_personality = erudite_explorers
					has_ai_personality = imperial_origin_overlord_ai
	
					has_authority = auth_corporate
					has_authority = auth_hive_mind
					has_authority = auth_machine_intelligence
				}
			}
		}
	}
}

double_shellworld_1 = {
	entity = "ssh_double_shellworld_1_entity"
	construction_entity = "ssh_double_shellworld_1_entity"
	portrait = "GFX_megastructure_construction_background"
	build_time = 3600 #10 years
	scales_with_planet = yes
	prerequisites = {
		ssh_tech_matrioshka_worlds
	}
	resources = {
		category = megastructures
		cost = {
			trigger = { country_uses_bio_ships = no }
			alloys = 7500
		}
		cost = {
			trigger = { country_uses_bio_ships = yes }
			alloys = 7500
			mult = 0.5
		}
		cost = {
			trigger = { country_uses_bio_ships = yes }
			food = 7500
			mult = @halved_alloy_to_food_cost_ratio
		}
		upkeep = {
			energy = 40
			alloys = 10
		}
	}
	upgrade_from = {
		double_shellworld_0
	}

	on_build_complete = {
		fromfrom.planet = {
			set_planet_flag = has_megastructure
			save_event_target_as = double_shellworld_planet
		}
		from = {
			country_event = { id = ssh_cn.5 }
		}
	}
}

double_shellworld_2 = {
	entity = "ssh_double_shellworld_2_entity"
	construction_entity = "ssh_double_shellworld_2_entity"
	portrait = "GFX_megastructure_construction_background"
	build_time = 1800 #5 years
	scales_with_planet = yes
	prerequisites = {
		ssh_tech_matrioshka_worlds
	}
	resources = {
		category = megastructures
		cost = {
			trigger = { country_uses_bio_ships = no }
			alloys = 7500
		}
		cost = {
			trigger = { country_uses_bio_ships = yes }
			alloys = 7500
			mult = 0.5
		}
		cost = {
			trigger = { country_uses_bio_ships = yes }
			food = 7500
			mult = @halved_alloy_to_food_cost_ratio
		}
		upkeep = {
			energy = 40
			alloys = 10
		}
	}
	upgrade_from = {
		double_shellworld_1
	}

	on_build_complete = {
		from = {
			country_event = { id = ssh_cn.6 }
		}
	}
}

double_shellworld_3 = {
	entity = "ssh_double_shellworld_3_entity"
	construction_entity = "ssh_double_shellworld_3_entity"
	portrait = "GFX_megastructure_construction_background"
	build_time = 1800 #5 years
	scales_with_planet = yes
	prerequisites = {
		ssh_tech_matrioshka_worlds
	}
	resources = {
		category = megastructures
		cost = {
			minerals = 17500
			exotic_gases = 750
			volatile_motes = 750
		}
		upkeep = {
			energy = 40
			alloys = 10
		}
	}
	upgrade_from = {
		double_shellworld_2
	}

	on_build_complete = {
		from = {
			set_country_flag = has_built_or_repaired_megastructure
			set_country_flag = ssh_has_built_or_repaired_tier_b_mega
		}
		if = {
			limit = { exists = fromfrom.planet }
			fromfrom.planet = {
				remove_planet_flag = has_megastructure
				remove_planet_flag = shellworld
				remove_planet_flag = is_under_shellworld_construction
				set_planet_flag = ssh_tier_b_mega
				set_planet_flag = double_shellworld
				#set_planet_flag = megastructure
				save_event_target_as = shellworld_planet

				if = {
					limit = { is_planet_class = pc_shellworld_core_gaia }
					ssh_set_gaia_shellworld_entity = yes
				}
				else_if = {
					limit = { is_planet_class = pc_shellworld_core_city }
					ssh_set_city_shellworld_entity = yes
				}
				else_if = {
					limit = { is_planet_class = pc_shellworld_core_hive }
					ssh_set_hive_shellworld_entity = yes
				}
				else_if = {
					limit = { is_planet_class = pc_shellworld_core_machine }
					ssh_set_machine_shellworld_entity = yes
				}
				else = {
					ssh_set_shellworld_entity = yes
				}

				remove_modifier = ssh_shellworld_planet_modifier
				add_modifier = {
					modifier = ssh_double_shellworld_planet_modifier
					days = -1
				}
			}
		}
		remove_megastructure = fromfrom
		from = {
			country_event = { id = ssh_cn.7 }
		}
	}
}